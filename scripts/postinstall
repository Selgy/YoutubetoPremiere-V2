#!/bin/bash

# Exit on any error
set -e

# Get the installation directory from the first argument
INSTALL_DIR="$3"

# Debug: Show what PKG provides
echo "PKG Arguments: $1 $2 $3 $4"
echo "Available in install directory:"
ls -la "$INSTALL_DIR" 2>/dev/null || echo "Install directory not accessible"

# The actual structure is likely in /Applications since we use --install-location /Applications
if [ -d "/Applications/YoutubetoPremiere" ]; then
    APP_DIR="/Applications/YoutubetoPremiere"
elif [ -d "$INSTALL_DIR/YoutubetoPremiere" ]; then
    APP_DIR="$INSTALL_DIR/YoutubetoPremiere"
else
    APP_DIR="$INSTALL_DIR/YoutubetoPremiere"
fi

if [ -d "/Applications/cep" ]; then
    EXTENSION_DIR="/Applications/cep"
elif [ -d "$INSTALL_DIR/cep" ]; then
    EXTENSION_DIR="$INSTALL_DIR/cep"
else
    EXTENSION_DIR="$INSTALL_DIR/com.selgy.youtubetopremiere"
fi

echo "=== YouTube to Premiere Pro - Post Install Script ==="
echo "Installation directory: $INSTALL_DIR"
echo "App directory: $APP_DIR"
echo "Extension directory: $EXTENSION_DIR"

# Debug: Check what's actually installed
echo "Checking installed files..."
if [ -d "$APP_DIR" ]; then
    echo "✅ App directory found:"
    ls -la "$APP_DIR"
else
    echo "❌ App directory not found: $APP_DIR"
fi

if [ -d "$EXTENSION_DIR" ]; then
    echo "✅ Extension directory found:"
    ls -la "$EXTENSION_DIR"
else
    echo "❌ Extension directory not found: $EXTENSION_DIR"
fi

# Find the actual user who initiated the installation
# When using sudo, SUDO_USER contains the original user
ACTUAL_USER="${SUDO_USER:-$(logname 2>/dev/null || whoami)}"
USER_HOME=$(eval echo "~$ACTUAL_USER")

echo "Detected user: $ACTUAL_USER"
echo "User home: $USER_HOME"

# Create CEP extension directories
echo "Creating CEP extension directories..."

# System-wide directory (for all users)
SYSTEM_CEP_DIR="/Library/Application Support/Adobe/CEP/extensions/com.selgy.youtubetopremiere"
mkdir -p "$SYSTEM_CEP_DIR"

# User-specific directory
USER_CEP_DIR="$USER_HOME/Library/Application Support/Adobe/CEP/extensions/com.selgy.youtubetopremiere"
mkdir -p "$USER_CEP_DIR"

echo "Created directories:"
echo "  System: $SYSTEM_CEP_DIR"
echo "  User: $USER_CEP_DIR"

# Copy extension files to CEP directories if they exist
if [ -d "$EXTENSION_DIR" ]; then
    echo "Copying extension files..."
    
    # Copy to system-wide CEP directory
    echo "  → Copying to system CEP directory..."
    cp -R "$EXTENSION_DIR/"* "$SYSTEM_CEP_DIR/"
    
    # Copy to user CEP directory
    echo "  → Copying to user CEP directory..."
    cp -R "$EXTENSION_DIR/"* "$USER_CEP_DIR/"
    
    echo "✅ Extension files copied successfully"
else
    echo "❌ Extension directory not found, skipping CEP installation"
fi

# Make sure the application is executable
echo "Setting executable permissions..."
if [ -f "$APP_DIR/YoutubetoPremiere" ]; then
    chmod +x "$APP_DIR/YoutubetoPremiere"
    echo "✅ Made YoutubetoPremiere executable"
fi

# Set permissions for CEP extension executables
if [ -f "$USER_CEP_DIR/exec/YoutubetoPremiere" ]; then
    chmod +x "$USER_CEP_DIR/exec/YoutubetoPremiere"
    echo "✅ Made CEP YoutubetoPremiere executable"
fi

if [ -f "$USER_CEP_DIR/exec/ffmpeg" ]; then
    chmod +x "$USER_CEP_DIR/exec/ffmpeg"
    echo "✅ Made CEP ffmpeg executable"
fi

# Set proper ownership and permissions
echo "Setting ownership and permissions..."

# System directory
chown -R root:wheel "$SYSTEM_CEP_DIR"
chmod -R 755 "$SYSTEM_CEP_DIR"

# User directory - get user and group
USER_GROUP=$(id -gn "$ACTUAL_USER" 2>/dev/null || echo "staff")
chown -R "$ACTUAL_USER:$USER_GROUP" "$USER_CEP_DIR"
chmod -R 755 "$USER_CEP_DIR"

echo "✅ Ownership and permissions set"

# Final verification
echo "=== Installation Verification ==="
if [ -d "$USER_CEP_DIR" ]; then
    echo "✅ CEP extension installed at: $USER_CEP_DIR"
    echo "Contents:"
    ls -la "$USER_CEP_DIR"
    
    if [ -f "$USER_CEP_DIR/CSXS/manifest.xml" ]; then
        echo "✅ Manifest file found"
    else
        echo "❌ Manifest file missing"
    fi
    
    if [ -d "$USER_CEP_DIR/exec" ]; then
        echo "✅ Exec directory found:"
        ls -la "$USER_CEP_DIR/exec"
    else
        echo "❌ Exec directory missing"
    fi
else
    echo "❌ CEP extension installation failed"
fi

echo "=== Post Install Completed ==="
exit 0 